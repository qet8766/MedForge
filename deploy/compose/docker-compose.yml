networks:
  medforge-control:
    driver: bridge
  medforge-external-sessions:
    external: true                        # Created by bootstrap-easy.sh with 172.30.0.0/24.
  medforge-internal-sessions:
    driver: bridge
    internal: true                        # Internal sessions: no outbound internet egress.

volumes:
  caddy_data:
  caddy_config:

services:
  # ── Database ──────────────────────────────────────────────
  medforge-db:
    image: mariadb:11@sha256:7fcb6109db2ba31b22a5709c1eaf9e84f76c9f1b9b9031ef09f24092f7f207cc
    container_name: medforge-db
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MARIADB_DATABASE: medforge
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
    volumes:
      - /tank/medforge/system/db:/var/lib/mysql
    networks:
      - medforge-control

  # ── API ───────────────────────────────────────────────────
  medforge-api:
    build:
      context: ../../apps/api
      args:
        DOCKER_GID: 995
    image: medforge-api:local
    user: "0:0"
    privileged: true
    container_name: medforge-api
    restart: unless-stopped
    depends_on:
      - medforge-db
    environment:
      DATABASE_URL: mysql+aiomysql://${DB_USER}:${DB_PASSWORD}@medforge-db:3306/medforge
      DOMAIN: ${DOMAIN}
      SESSION_SECRET: ${SESSION_SECRET}
      EXTERNAL_SESSIONS_NETWORK: ${EXTERNAL_SESSIONS_NETWORK}
      INTERNAL_SESSIONS_NETWORK: ${INTERNAL_SESSIONS_NETWORK}
      WORKSPACE_ZFS_ROOT: ${WORKSPACE_ZFS_ROOT}
      SESSION_ALLOCATION_MAX_RETRIES: ${SESSION_ALLOCATION_MAX_RETRIES}
      SESSION_CONTAINER_START_TIMEOUT_SECONDS: ${SESSION_CONTAINER_START_TIMEOUT_SECONDS}
      SESSION_CONTAINER_STOP_TIMEOUT_SECONDS: ${SESSION_CONTAINER_STOP_TIMEOUT_SECONDS}
      SESSION_WORKSPACE_QUOTA_GB: ${SESSION_WORKSPACE_QUOTA_GB}
      SESSION_RUNTIME_MODE: ${SESSION_RUNTIME_MODE}
      SESSION_RUNTIME_USE_SUDO: ${SESSION_RUNTIME_USE_SUDO}
      SESSION_RECOVERY_ENABLED: ${SESSION_RECOVERY_ENABLED}
      SESSION_POLL_INTERVAL_SECONDS: ${SESSION_POLL_INTERVAL_SECONDS}
      SESSION_CPU_SHARES: ${SESSION_CPU_SHARES}
      SESSION_CPU_LIMIT: ${SESSION_CPU_LIMIT}
      SESSION_MEM_LIMIT: ${SESSION_MEM_LIMIT}
      SESSION_MEM_RESERVATION: ${SESSION_MEM_RESERVATION}
      SESSION_SHM_SIZE: ${SESSION_SHM_SIZE}
      SESSION_PIDS_LIMIT: ${SESSION_PIDS_LIMIT}
      PACK_IMAGE: ${PACK_IMAGE}                   # e.g. medforge-pack-default@sha256:...
      AUTO_SCORE_ON_SUBMIT: ${AUTO_SCORE_ON_SUBMIT}
      TRAINING_DATA_ROOT: ${TRAINING_DATA_ROOT:-/data/medforge/datasets/train}
      PUBLIC_EVAL_DATA_ROOT: ${PUBLIC_EVAL_DATA_ROOT:-data/public-eval}
      TEST_HOLDOUTS_DIR: ${TEST_HOLDOUTS_DIR:-data/scoring-holdouts}
      AUTH_IDLE_TTL_SECONDS: ${AUTH_IDLE_TTL_SECONDS}
      AUTH_MAX_TTL_SECONDS: ${AUTH_MAX_TTL_SECONDS}
      COOKIE_NAME: ${COOKIE_NAME}
      COOKIE_DOMAIN: ${COOKIE_DOMAIN}
      COOKIE_SECURE: ${COOKIE_SECURE}
      COOKIE_SAMESITE: ${COOKIE_SAMESITE}
    volumes:
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock               # Manage session containers.
      - type: bind
        source: /tank
        target: /tank                              # Workspace mountpoints for chown/quota operations.
        bind:
          propagation: rshared
    # ZFS snapshot commands require host-level access.
    # The API shells out to `zfs snapshot`; mount the binary + device.
    devices:
      - /dev/zfs:/dev/zfs
    cap_add:
      - SYS_ADMIN                                  # Required for ZFS ioctls.
    networks:
      medforge-control: {}
      medforge-external-sessions:
        ipv4_address: 172.30.0.3
      medforge-internal-sessions: {}

  # ── Scoring worker ───────────────────────────────────────
  medforge-api-worker:
    image: medforge-api:local
    container_name: medforge-api-worker
    restart: unless-stopped
    depends_on:
      - medforge-db
    command: ["python", "-m", "app.worker", "--interval", "5", "--batch-size", "10"]
    environment:
      DATABASE_URL: mysql+aiomysql://${DB_USER}:${DB_PASSWORD}@medforge-db:3306/medforge
      AUTO_SCORE_ON_SUBMIT: ${AUTO_SCORE_ON_SUBMIT}
      TRAINING_DATA_ROOT: ${TRAINING_DATA_ROOT:-/data/medforge/datasets/train}
      PUBLIC_EVAL_DATA_ROOT: ${PUBLIC_EVAL_DATA_ROOT:-data/public-eval}
      TEST_HOLDOUTS_DIR: ${TEST_HOLDOUTS_DIR:-data/scoring-holdouts}
    networks:
      - medforge-control

  # ── Frontend ──────────────────────────────────────────────
  medforge-web:
    build:
      context: ../../apps/web
      args:
        NEXT_PUBLIC_API_URL: https://api.${DOMAIN}
        NEXT_PUBLIC_DOMAIN: ${DOMAIN}
        DOMAIN: ${DOMAIN}
    container_name: medforge-web
    restart: unless-stopped
    depends_on:
      - medforge-api
    environment:
      API_URL: http://medforge-api:8000
      NEXT_PUBLIC_API_URL: https://api.${DOMAIN}
      NEXT_PUBLIC_DOMAIN: ${DOMAIN}
    networks:
      - medforge-control

  # ── Reverse proxy ────────────────────────────────────────
  medforge-caddy:
    build: ../caddy
    container_name: medforge-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"                              # HTTP/3
    environment:
      DOMAIN: ${DOMAIN}
      ACME_EMAIL: ${ACME_EMAIL}
      CF_API_TOKEN: ${CF_API_TOKEN}
    volumes:
      - ../caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      medforge-control: {}
      medforge-external-sessions:
        ipv4_address: 172.30.0.2                   # Fixed IP for firewall rules.
      medforge-internal-sessions: {}
