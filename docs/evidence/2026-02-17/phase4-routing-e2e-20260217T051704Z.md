## Phase 4 Routing and End-to-End Evidence (2026-02-17)

Generated by: `ops/host/validate-phase4-routing-e2e.sh`

Runtime:
- phase id: `phase4-routing-e2e`
- run id: `20260217T051704Z`
- API URL: `http://127.0.0.1:8000`
- Request API URL: `http://api.medforge.localtest.me:18080`
- Pack image: `medforge-pack-default:local@sha256:7e44d4e67aa5c7bbc51701be7f370f45de35794cc7f2504f761b1a510f1c1a6e`
- DB path: `/home/shk/projects/MedForge/apps/api/phase4-evidence.db`
- Core-only mode: `false`
- Browser lane enabled: `true`
- Browser base URL: `http://medforge.localtest.me:18080`
- Browser domain: `localtest.me`
- Browser user: `e2e-1771305424@medforge.test`

### Create Sessions

- create A: `{"data":{"message":"Session started.","session":{"id":"f981ee1d-92e8-4908-9037-5d066450fa20","user_id":"017f3194-c05f-4d3b-89c2-b1ed7d6bda7a","tier":"public","pack_id":"00000000-0000-0000-0000-000000000100","status":"running","container_id":"583103b0cba0aebf7890f54017e58256ae8b330e0da46c6a329657b3c701e603","gpu_id":0,"slug":"3facpzqi","workspace_zfs":"tank/medforge/workspaces/017f3194-c05f-4d3b-89c2-b1ed7d6bda7a/f981ee1d-92e8-4908-9037-5d066450fa20","created_at":"2026-02-17T05:17:08.232965","started_at":"2026-02-17T05:17:08.892779","stopped_at":null,"error_message":null}},"meta":{"request_id":"be4d05f6-e426-4634-848b-1f40f2290b38","api_version":"v1.0","timestamp":"2026-02-17T05:17:08.906209Z","limit":null,"next_cursor":null,"has_more":null}}`
- create B: `{"data":{"message":"Session started.","session":{"id":"42a1db64-f24e-4a5d-96ca-027172937a57","user_id":"bc67c320-96d5-40e7-b73e-c9e5057aa7ef","tier":"public","pack_id":"00000000-0000-0000-0000-000000000100","status":"running","container_id":"be73c55c6e8399177bb245baed698a344fb9b46f6c672be247f9b985c944cf23","gpu_id":1,"slug":"2djkj3ec","workspace_zfs":"tank/medforge/workspaces/bc67c320-96d5-40e7-b73e-c9e5057aa7ef/42a1db64-f24e-4a5d-96ca-027172937a57","created_at":"2026-02-17T05:17:09.010382","started_at":"2026-02-17T05:17:09.651730","stopped_at":null,"error_message":null}},"meta":{"request_id":"2f5ff3cb-7e27-463b-9fe3-14d886498930","api_version":"v1.0","timestamp":"2026-02-17T05:17:09.665624Z","limit":null,"next_cursor":null,"has_more":null}}`

### Routing Authorization Matrix

- unauthenticated: `401` body=`{"type":"https://medforge.dev/problems/http/401","title":"Unauthorized","status":401,"detail":"Authentication required.","instance":"/api/v1/auth/session-proxy","code":"401","request_id":"db142ad3-9be4-466c-be52-74cd94891f0a"}`
- non-owner: `403` body=`{"type":"https://medforge.dev/problems/http/403","title":"Forbidden","status":403,"detail":"Session access denied.","instance":"/api/v1/auth/session-proxy","code":"403","request_id":"1d219c8f-b971-4af9-bb09-c241de294940"}`
- owner spoof attempt: `200` x-upstream=`mf-session-3facpzqi:8080`

### East-West Isolation

- firewall: `East–west isolation applied (bridge=br-55088beacfcf, caddy=172.30.0.4)`
- session B -> session A :8080 blocked (exit=`28`, stderr=`curl: (28) Connection timed out after 3002 milliseconds`)

### End-to-End Core Runtime

- GPU in session A: `NVIDIA GeForce RTX 5090`
- workspace write/read: `alpha`
- stop A: `{"data":{"message":"Session stop requested."},"meta":{"request_id":"5943a247-5bac-4f53-b867-55e0b41ec9b8","api_version":"v1.0","timestamp":"2026-02-17T05:17:13.232658Z","limit":null,"next_cursor":null,"has_more":null}}`
- stopped host check: `404` body=`{"type":"https://medforge.dev/problems/http/404","title":"Not Found","status":404,"detail":"Session not found.","instance":"/api/v1/auth/session-proxy","code":"404","request_id":"d5cdf539-ca4b-4594-99e7-548f6b8f41a1"}`
- snapshot: `tank/medforge/workspaces/017f3194-c05f-4d3b-89c2-b1ed7d6bda7a/f981ee1d-92e8-4908-9037-5d066450fa20@stop-1771305436536`
- stop B: `{"data":{"message":"Session stop requested."},"meta":{"request_id":"ddc0c564-bdd6-453b-9655-42e988249077","api_version":"v1.0","timestamp":"2026-02-17T05:17:17.550364Z","limit":null,"next_cursor":null,"has_more":null}}`

### Browser + Websocket Lane

- browser base URL: `http://medforge.localtest.me:18080`
- e2e user: `e2e-1771305424@medforge.test`
- wildcard session URL: `http://s-poy5mgfy.medforge.localtest.me:18080`
- wildcard slug: `poy5mgfy`
- websocket attempts observed: `1`
- websocket connections with frame traffic: `1`
- websocket auth 403 entries: `0`

### API Log Snippet

```text
INFO:     Started server process [361692]
INFO:     Waiting for application startup.
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> 2474ec93cdb5, initial_schema
INFO  [alembic.runtime.migration] Running upgrade 2474ec93cdb5 -> a1b2c3d4e5f6, drop_gpu_active
2026-02-17 14:17:08 [info     ] session.start                  gpu_id=0 pack_id=00000000-0000-0000-0000-000000000100 request_id=be4d05f6-e426-4634-848b-1f40f2290b38 session_id=f981ee1d-92e8-4908-9037-5d066450fa20 slug=3facpzqi tier=PUBLIC user_id=017f3194-c05f-4d3b-89c2-b1ed7d6bda7a
2026-02-17 14:17:09 [info     ] session.start                  gpu_id=1 pack_id=00000000-0000-0000-0000-000000000100 request_id=2f5ff3cb-7e27-463b-9fe3-14d886498930 session_id=42a1db64-f24e-4a5d-96ca-027172937a57 slug=2djkj3ec tier=PUBLIC user_id=bc67c320-96d5-40e7-b73e-c9e5057aa7ef
2026-02-17 14:17:11 [info     ] session.recovery.decision      container_id=583103b0cba0aebf7890f54017e58256ae8b330e0da46c6a329657b3c701e603 correlation_id=8eb1219b-1562-49a6-bfd9-73b214549ab9 recovery_mode=poll session_id=f981ee1d-92e8-4908-9037-5d066450fa20 slug=3facpzqi state=running user_id=017f3194-c05f-4d3b-89c2-b1ed7d6bda7a
2026-02-17 14:17:11 [info     ] session.recovery.decision      container_id=be73c55c6e8399177bb245baed698a344fb9b46f6c672be247f9b985c944cf23 correlation_id=8eb1219b-1562-49a6-bfd9-73b214549ab9 recovery_mode=poll session_id=42a1db64-f24e-4a5d-96ca-027172937a57 slug=2djkj3ec state=running user_id=bc67c320-96d5-40e7-b73e-c9e5057aa7ef
2026-02-17 14:17:16 [info     ] session.stop                   correlation_id=0e1db3ec-2307-4810-930b-79ac05d3867f gpu_id=0 pack_id=00000000-0000-0000-0000-000000000100 reason=requested recovery_mode=poll session_id=f981ee1d-92e8-4908-9037-5d066450fa20 slug=3facpzqi tier=PUBLIC user_id=017f3194-c05f-4d3b-89c2-b1ed7d6bda7a
2026-02-17 14:17:16 [info     ] session.recovery.decision      container_id=be73c55c6e8399177bb245baed698a344fb9b46f6c672be247f9b985c944cf23 correlation_id=0e1db3ec-2307-4810-930b-79ac05d3867f recovery_mode=poll session_id=42a1db64-f24e-4a5d-96ca-027172937a57 slug=2djkj3ec state=running user_id=bc67c320-96d5-40e7-b73e-c9e5057aa7ef
2026-02-17 14:17:16 [info     ] session.poll.updated           correlation_id=0e1db3ec-2307-4810-930b-79ac05d3867f recovery_mode=poll updated=1
2026-02-17 14:17:21 [info     ] session.stop                   correlation_id=0c58fcfc-404f-4007-86d1-f5c177a3d2bb gpu_id=1 pack_id=00000000-0000-0000-0000-000000000100 reason=requested recovery_mode=poll session_id=42a1db64-f24e-4a5d-96ca-027172937a57 slug=2djkj3ec tier=PUBLIC user_id=bc67c320-96d5-40e7-b73e-c9e5057aa7ef
2026-02-17 14:17:21 [info     ] session.poll.updated           correlation_id=0c58fcfc-404f-4007-86d1-f5c177a3d2bb recovery_mode=poll updated=1
2026-02-17 14:17:37 [info     ] session.start                  gpu_id=0 pack_id=00000000-0000-0000-0000-000000000100 request_id=fa7bd0af-0c49-4620-bcbb-819c6bb5664b session_id=4b7f72a0-1ad2-4c6d-93f7-9ecff00d024b slug=poy5mgfy tier=PUBLIC user_id=97b9505b-eabf-4d3c-aeaa-d2bff986c50b
```

### Web Log Snippet

```text

> medforge-web@0.1.0 dev
> next dev --hostname 0.0.0.0 --port 3000

▲ Next.js 16.1.6 (Turbopack)
- Local:         http://localhost:3000
- Network:       http://0.0.0.0:3000

✓ Starting...
✓ Ready in 571ms
 GET / 200 in 489ms (compile: 246ms, render: 244ms)
 GET /auth/login 200 in 96ms (compile: 22ms, render: 74ms)
⚠ Cross origin request detected from medforge.localtest.me to /_next/* resource. In a future major version of Next.js, you will need to explicitly configure "allowedDevOrigins" in next.config to allow this.
Read more: https://nextjs.org/docs/app/api-reference/config/next-config-js/allowedDevOrigins
 GET /auth/signup 200 in 76ms (compile: 24ms, render: 53ms)
 GET /sessions 200 in 67ms (compile: 19ms, render: 48ms)
 GET /auth/login 200 in 43ms (compile: 3ms, render: 40ms)
 GET /sessions 200 in 37ms (compile: 2ms, render: 34ms)
```

### Caddy Log Snippet

```text
{"level":"info","ts":1771305427.2471392,"msg":"maxprocs: Leaving GOMAXPROCS=128: CPU quota undefined"}
{"level":"info","ts":1771305427.247299,"msg":"GOMEMLIMIT is updated","package":"github.com/KimMachineGun/automemlimit/memlimit","GOMEMLIMIT":486097462886,"previous":9223372036854775807}
{"level":"info","ts":1771305427.2473292,"msg":"using config from file","file":"/etc/caddy/Caddyfile"}
{"level":"warn","ts":1771305427.2481291,"logger":"caddyfile","msg":"Unnecessary header_up X-Forwarded-For: the reverse proxy's default behavior is to pass headers to the upstream"}
{"level":"warn","ts":1771305427.2481842,"logger":"caddyfile","msg":"Unnecessary header_up X-Forwarded-Proto: the reverse proxy's default behavior is to pass headers to the upstream"}
{"level":"info","ts":1771305427.2488105,"msg":"adapted config to JSON","adapter":"caddyfile"}
{"level":"warn","ts":1771305427.2488205,"msg":"Caddyfile input is not formatted; run 'caddy fmt --overwrite' to fix inconsistencies","adapter":"caddyfile","file":"/etc/caddy/Caddyfile","line":2}
{"level":"info","ts":1771305427.2510557,"logger":"admin","msg":"admin endpoint started","address":"localhost:2019","enforce_origin":false,"origins":["//localhost:2019","//[::1]:2019","//127.0.0.1:2019"]}
{"level":"info","ts":1771305427.2512386,"logger":"http.auto_https","msg":"automatic HTTPS is completely disabled for server","server_name":"srv0"}
{"level":"info","ts":1771305427.2513163,"logger":"tls.cache.maintenance","msg":"started background certificate maintenance","cache":"0xc0007fcf80"}
{"level":"warn","ts":1771305427.25334,"logger":"http","msg":"HTTP/2 skipped because it requires TLS","network":"tcp","addr":":18080"}
{"level":"warn","ts":1771305427.2534525,"logger":"http","msg":"HTTP/3 skipped because it requires TLS","network":"tcp","addr":":18080"}
{"level":"info","ts":1771305427.2534575,"logger":"http.log","msg":"server running","name":"srv0","protocols":["h1","h2","h3"]}
{"level":"info","ts":1771305427.2595332,"msg":"autosaved config (load with --resume flag)","file":"/config/caddy/autosave.json"}
{"level":"info","ts":1771305427.2595663,"msg":"serving initial configuration"}
{"level":"info","ts":1771305427.2695296,"logger":"tls","msg":"cleaning storage unit","storage":"FileStorage:/data/caddy"}
{"level":"info","ts":1771305427.27213,"logger":"tls","msg":"finished cleaning storage units"}
{"level":"error","ts":1771305427.3507566,"logger":"http.log.error","msg":"dial tcp 172.30.0.1:3000: connect: connection refused","request":{"remote_ip":"172.30.0.1","remote_port":"57610","client_ip":"172.30.0.1","proto":"HTTP/1.1","method":"GET","host":"medforge.localtest.me:18080","uri":"/","headers":{"User-Agent":["curl/8.5.0"],"Accept":["*/*"]}},"duration":0.000477468,"status":502,"err_id":"z2kgar2re","err_trace":"reverseproxy.statusError (reverseproxy.go:1390)"}
```
